#!/usr/bin/env ruby
# frozen_string_literal: true

def jira_issue_number
  `git rev-parse --abbrev-ref HEAD`.match(/^POT-(\d*)/)[1]
end

def jira_summary
  `jira summary #{jira_issue_number}`.strip
end

def jira_description
  %(`jira view --field=description -t debug POT-#{jira_issue_number} | jq -r ".fields.description"`)
end

def accomplishments
  commits = `git log --pretty="%s" origin/develop..HEAD`.split("\n")
  commits.map do |commit|
    %(- [x] #{commit.match(/^POT-\d*\W(.*)/)[1]})
  end.join("\n")
end

def github_pr_title
  "POT-#{jira_issue_number} #{jira_summary}"
end

def github_pr_message
  "### Why\n\n" \
  "#{jira_description}\n\n" \
  "### Ticket\n\n" \
  "https://potloc.atlassian.net/browse/POT-#{jira_issue_number}\n\n" \
  "### Accomplishments\n\n" \
  "#{accomplishments}\n\n" \
  "### Testing\n\n" \
  "_none_"
end

system("hub pull-request --base develop \
                         --push \
                         --draft \
                         --assign mathieugagne \
                         --message \"#{github_pr_title}\" \
                         --message \"#{github_pr_message}\"")
